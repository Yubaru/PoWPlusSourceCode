# DDLC-styled Animated Loading Bar using Ren'Py bar widget only
image kingcrimsonface_start:
    "mod_assets/images/effect/facetransition/face_00002.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00003.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00004.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00005.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00006.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00007.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00008.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00009.png"
    pause 0.0417


image kingcrimsonface_loop:
    "mod_assets/images/effect/facetransition/face_00010.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00011.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00012.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00013.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00014.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00015.png"
    pause 0.0417
    "mod_assets/images/effect/facetransition/face_00016.png"
    repeat

image kingcrimsonexplode:
    "mod_assets/images/effect/explode/explode_00001.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00002.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00003.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00004.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00005.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00006.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00007.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00008.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00009.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00010.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00011.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00012.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00013.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00014.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00015.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00016.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00017.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00018.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00019.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00020.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00021.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00022.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00023.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00024.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00025.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00026.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00027.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00028.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00029.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00030.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00031.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00032.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00033.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00034.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00035.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00036.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00037.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00038.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00039.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00040.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00041.png"
    pause 0.0417
    "mod_assets/images/effect/explode/explode_00042.png"

image kingcrimson_end:
    "mod_assets/images/effect/crimson/crimson_00001.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00002.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00003.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00004.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00005.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00006.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00007.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00008.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00009.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00010.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00011.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00012.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00013.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00014.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00015.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00016.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00017.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00018.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00019.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00020.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00021.png"
    pause 0.0417
    "mod_assets/images/effect/crimson/crimson_00022.png"
    pause 0.0417



init python:
    _bar_progress = 0.0
    subtitle_text = ""

screen animated_loading_bar(duration=10.0):
    frame:
        xalign 0.5
        yalign 0.95
        background None
        xsize 1280
        ysize 160
        vbox:
            spacing 20
            xfill True
            text "[int(_bar_progress*100)]%" xalign 0.5 size 38 color "#6dc8df" outlines [(2, "#fff", 0, 0)]
            bar:
                value VariableValue('_bar_progress', 1.0)
                xmaximum 1300
                xalign 0.0
                xfill True
                ymaximum 36
                thumb None
                bar_invert False
            bar:
                value VariableValue('_bar_progress', 1.0)
                xmaximum 1300
                xalign 0.0
                xfill True
                ymaximum 20
                thumb None
                bar_invert False
                style "progress_bar2"

init -1 style progress_bar2 is bar:
    ysize 20
    left_bar "#6dc8df"
    right_bar "#fff"
    thumb None
    bar_invert False

label show_animated_loading_bar:
    pause 1.0
    scene bg loadingscreen
    with dissolve
    $ _bar_progress = 0.0
    $ duration = 10.0
    $ steps = 500
    $ pause_time = duration / steps
    show screen animated_loading_bar(duration=duration)
    $ i = 0
    # 1. Fill from 0% to 99%
    while _bar_progress < 0.99:
        $ _bar_progress = float(i + 1) / steps
        if _bar_progress > 0.99:
            $ _bar_progress = 0.99
        $ renpy.pause(pause_time)
        $ i += 1
    # 2. Pause at 99% for 3 seconds
    $ renpy.pause(3.0)
    # 3. Go down to 45% over 1 second (20 steps)
    $ down_steps = 20
    $ start = _bar_progress
    $ end = 0.45
    $ j = 0
    while j < down_steps:
        $ _bar_progress = start + (end - start) * (float(j + 1) / down_steps)
        $ renpy.pause(1.0 / down_steps)
        $ j += 1
    # 4. Go up to 56% very slowly over 8 seconds (160 steps)
    $ up_steps = 160
    $ up_duration = 8.0
    $ start = _bar_progress
    $ end = 0.56
    $ j = 0
    while j < up_steps:
        $ _bar_progress = start + (end - start) * (float(j + 1) / up_steps)
        $ renpy.pause(up_duration / up_steps)
        $ j += 1
    # 5. Stop at 56%
    $ _bar_progress = 0.56
    # 6. Stay at 56% for 5 seconds
    $ renpy.pause(9.0)
    play sound "mod_assets/sfx/kingcrimsontalk.ogg"
    call show_subtitles([
        ("Why is the loading bar taking so long?", 2.2),
        ("This is getting me annoyed. King Crimson will not stand for it!", 4.2),
        ("King Crimson! Time has been erased!", 2.2)
    ])
    # 7. While bar is still visible, play crimson_transition
    call crimson_transition
    hide screen animated_loading_bar
    return

label loading_screen_start:
    call killerqueen_transition
    # After animation, show the loading bar
    call show_animated_loading_bar
    return 

transform fit_screen:
    zoom 1.0
    fit "contain"
    xalign 0.5
    yalign 0.5

label killerqueen_transition:
    window hide
    play sound "mod_assets/sfx/killerqueen.ogg"
    show kingcrimsonface_start at fit_screen zorder 100
    pause 0.5
    hide kingcrimsonface_start
    show kingcrimsonface_loop at fit_screen zorder 100
    pause 4.0
    hide kingcrimsonface_loop
    hide kingcrimsonface_start
    show kingcrimsonexplode at fit_screen zorder 100
    pause 1.08
    show black zorder 50
    hide monika
    pause 0.42
    hide kingcrimsonexplode
    return

label crimson_transition:
    hide screen animated_loading_bar
    play sound "mod_assets/sfx/crimson_transition.ogg"
    
    # Show the animation at center
    show kingcrimson_end at fit_screen zorder 100
    
    # Wait for animation to complete (24 frames / 24 fps = 1 second)
    $ renpy.pause(1.0, hard=True)
    
    # Hide the animation
    hide kingcrimson
    
    return

screen subtitle_display():
    zorder 9999
    frame:
        background None
        xalign 0.5
        yalign 0.08
        xsize 1000
        ysize 80
        text "[subtitle_text]" xalign 0.5 yalign 0.5 size 38 color "#fff" font "mod_assets/fonts/trebuc.ttf" outlines [(2, "#000", 0, 0)] layout "nobreak"

label show_subtitles(subs):
    # subs: list of (text, duration) tuples
    python:
        global subtitle_text
        for line, duration in subs:
            subtitle_text = line
            renpy.show_screen("subtitle_display")
            renpy.pause(duration)
            renpy.hide_screen("subtitle_display")
        subtitle_text = ""
    return

# Example usage:
# call show_subtitles([
#     ("First subtitle line", 2.0),
#     ("Second line appears after 2 seconds", 3.5),
#     ("Final line, stays for 1 second", 1.0)
# ]) 
